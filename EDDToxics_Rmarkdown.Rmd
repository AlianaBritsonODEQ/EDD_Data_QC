---
params:
  org: NA
  num: NA
  qls: NA
  methods: NA
  diff: NA
  reject: NA
  data: NA
  qlcom: NA
  mcom: NA
  dfcom: NA
  rejcom: NA
  permnum: NA
  polc: NA
output: pdf_document
header-includes:
  \usepackage{booktabs}
  \usepackage{float}
  \usepackage{longtable}
  \usepackage{array}
---

# `r paste("EDD Toxics Report for: ",params$org)` 
# `r paste("Permit Number: ",params$permnum)`
## `r paste("Number of Sampling Events: ",params$num)`
## Report by: Aliana Britson 

```{r setup-packages-functions, include=FALSE}
library(knitr)

#including kableExtra seems to mess with booktabs and float latex packages, so compile fails on second pdf. 
#included packages in YAML header to fix problem
library(kableExtra)
library(tinytex)

```
## Sampling Information and Pollutants Analyzed
Table 1 contains the sampling dates, project, location, and method of sample collection.  A "24 hr Composite"" is a sample that was collected over the course of 24 hours. A "Composite"" sample is a sample that is made up of six discreete grab samples. Please note that two consecutive days are likely one sampling event, as a 24 hour sample can be started on the same day as other samples and not end until the next day (Dates for 24 hr samples are always the end date of the sample).

```{r echo=FALSE}
info<-unique(subset(params$data,select=c(SampleStartDate,Project1,StationDes,MLocID,SamplingMethod)))
info<-info[order(info$SampleStartDate),]
#summarize samplingmethod into one column
grp<-info %>% group_by(SampleStartDate) %>%
  summarize(type=paste(sort(unique(SamplingMethod)),collapse=", "))
mer<-merge(info,grp, by="SampleStartDate")
mer<-unique(subset(mer,select=c(SampleStartDate,Project1,StationDes,MLocID,type)))

names(mer)<-c("Sample Date","Project","Station Description","Location ID","Sample Collection Method(s)")

kable(mer, format='latex',caption="Sampling Event Information",booktabs=TRUE,row.names = FALSE) %>%
  kable_styling(latex_options=c("HOLD_position","scale_down"))
```
Table 2 contains a list of pollutants analyzed and submitted by the permittee. Please see individual permit for list of required polluants and the monitoring schedule. 
``` {r echo=FALSE, results='asis'}
#get the unique names of the pollutants
dat<-namefrac(params$data)
chars<-count(dat, Char_Name, CASNumber)
#sort them alphabetially
chars<-chars[order(chars$Char_Name),]

names(chars)<-c("Pollutant","CAS Number","Observations")
#will likely need to split into a few tables, a list is overwhelming if permittee does full suite of volatiles and semi-volatiles

kable(chars, format='latex', caption="List of Analyzed Pollutants", booktabs=TRUE,longtable=TRUE) %>%
 kable_styling(latex_option="HOLD_position")

if(length(params$polc)!=0) {cat("**Water Quality Data Steward Comments:**",params$polc)}
```


## Quantitation Limits 
A quantitation limit (QL) is the lowest amount of a pollutant that can be reliably measured. Permittees are required to use the most sensitive analytical test method, as specified in 40 CFR 122.44(i)(1)(iv). Established QL requirements were adopted in 2007 for NPDES permits and updated in 2015 by DEQ LEAD. 

The following table includes a list of pollutants for which the provided QLs are not sufficiently sensitive. This table uses the current established QLs from DEQ LEAD that were updated in 2015. In some cases, permitees have the option of providing matrix or sample specific QLs, please see the individual permit for any permittee-specific QLs. 

``` {r echo=FALSE, results='asis'}
qlc<-params$qls
qlc<-subset(qlc,select=c("Char_Name","act_id","Result","MRLValue","MRLUnit","QL","QL_Unit"))
#rename columns
names(qlc)<-c("Pollutant","Activity ID","Result","Submitted QL","Unit","Established QL","Unit")

 if(nrow(qlc)!=0) {kable(qlc, format='latex', caption="Insufficient Quantitation Limits",booktabs=TRUE, row.names=FALSE) %>%
  kable_styling(latex_options=c("HOLD_position","scale_down"))} else{cat("**NO KNOWN ISSUES**")}

if(nrow(qlc)!=0) {cat("**Water Quality Data Steward Comments:**",params$qlcom)}

```



## Methods 
 Permittees are required to use methods approved under 40 CFR 136. There are some pollutants that have no approved methods under 40 CFR 136. In some cases, permittees may obtain approval to perform different methods for specific pollutants through EPA. These instances are permittee-specific and should be contained within the permit. Please see the individual permit. 


``` {r echo=FALSE, results='asis'}
methd<-namefrac(params$methods)

#shorten the long agency names
methd<-methd %>%
       mutate(Method_Context=str_replace(Method_Context,"U.S. Environmental Protection Agency","US EPA")) %>%
       mutate(Method_Context=str_replace(Method_Context,"Georgia-Pacific Consumer Operations LLC",
                                         "Georgia-Pacific")) %>%
       mutate(Method_Context=str_replace(Method_Context,"American Public Health Association","APHA"))

#sort by pollutant
methd<-methd[order(methd$Char_Name),]

names(methd)<-c("Pollutant","Method","Agency","Method Status")
if(nrow(methd)!=0) {kable(methd, format='latex', caption="Pollutants analyzed using non-CFR methods",booktabs=TRUE, row.names=FALSE, longtable=TRUE) %>%
                   kable_styling(latex_options=c("HOLD_position")) %>%
                   column_spec(1,"5cm")} else {cat("**NO KNOWN ISSUES**")}

if(nrow(methd)!=0) {cat("**Water Quality Data Steward Comments:**",params$mcom)}
```


## Total Recoverable vs Dissolved
In the analysis of metals, the dissolved fraction of the pollutant should be less than the total recoverable fraction of the pollutant. However, there are some cases where sample contamination from an outside source or method uncertainty causes the dissolved fraction to be larger than the total recoverable fraction. &nbsp;

``` {r echo=FALSE,results='asis'}

dff<-params$diff
colnames(dff)[2]<-"Char_Name"
dff<-namefrac(dff)
dff<-subset(dff,select=c(act_id.x,Char_Name,Result_Numeric,Result_Unit,diff,RPD))
names(dff)<-c("Activty ID", "Pollutant", "Result","Unit", "Difference","RPD")

if(nrow(dff)!=0) {kable(dff, format='latex', caption="Metals with dissolved fraction larger than total recoverable fraction", booktabs=TRUE, row.names=FALSE) %>%
  kable_styling(latex_options=c("HOLD_position","scale_down"))} else {cat("**NO KNOWN ISSUES**")}

if(nrow(dff)!=0) {cat("**Water Quality Data Steward Comments:**",params$dfcom)}
```


## Rejected Data
In some cases, data does not pass quality control analysis. This data may still be usable for permitting purposes, but must be used with caution.  &nbsp;

``` {r echo=FALSE, results='asis'}
rej<-params$reject
rej<-subset(rej,select=c(act_id, Char_Name, Result, Result_Unit, Result_Comment))
names(rej)<-c("Activity ID","Pollutant","Result","Result_Unit","Result_Comment")
if(nrow(rej)!=0) {kable(rej,format='latex', caption="Rejected Data",booktabs=TRUE, row.names=FALSE) %>%
                  kable_styling(latex_options=c("HOLD_position","scale_down")) %>%
                  column_spec(5,"10cm")} else {cat("**NO KNOWN ISSUES**")}

if(nrow(rej)!=0) {cat("**Water Quality Data Steward Comments:**", params$rejcom)}
